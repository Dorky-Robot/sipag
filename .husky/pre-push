#!/usr/bin/env bash

# --- Inline smoke tests (fallback if bats not installed) ---

echo "pre-push: validating safety gate hook..."
HOOK_TESTS_PASSED=1

_test_hook() {
  local desc="$1" input="$2" expected="$3"
  local result
  result=$(echo "$input" | SIPAG_SAFETY_MODE=strict CLAUDE_PROJECT_DIR=/tmp/project bash lib/hooks/safety-gate.sh 2>/dev/null | jq -r '.hookSpecificOutput.permissionDecision' 2>/dev/null)
  if [[ "$result" != "$expected" ]]; then
    echo "  FAIL: $desc (expected $expected, got $result)"
    HOOK_TESTS_PASSED=0
  fi
}

_test_hook "Read tool allowed" \
  '{"tool_name":"Read","tool_input":{"file_path":"/tmp/test.txt"}}' "allow"
_test_hook "Dangerous command denied" \
  '{"tool_name":"Bash","tool_input":{"command":"sudo rm -rf /"}}' "deny"
_test_hook "Git status allowed" \
  '{"tool_name":"Bash","tool_input":{"command":"git status"}}' "allow"
_test_hook "Write outside project denied" \
  '{"tool_name":"Write","tool_input":{"file_path":"/etc/passwd"}}' "deny"

if [[ "$HOOK_TESTS_PASSED" -ne 1 ]]; then
  echo "pre-push: BLOCKED — safety gate hook tests failed."
  exit 1
fi
echo "pre-push: safety gate smoke tests passed"

# --- Determine what commits are being pushed ---

# Pre-push hook receives: <local ref> <local sha> <remote ref> <remote sha>
ZERO="0000000000000000000000000000000000000000"
PUSH_DIFF=""
CHANGED_FILES=""

while read -r local_ref local_sha remote_ref remote_sha; do
  if [[ "$local_sha" = "$ZERO" ]]; then
    # Deleting a branch, nothing to review
    continue
  fi

  if [[ "$remote_sha" = "$ZERO" ]]; then
    # New branch — diff against where it diverged from main
    MERGE_BASE=$(git merge-base main "$local_sha" 2>/dev/null || echo "")
    if [[ -n "$MERGE_BASE" ]]; then
      PUSH_DIFF+=$'\n'$(git diff "$MERGE_BASE".."$local_sha")
      CHANGED_FILES+=$'\n'$(git diff --name-only "$MERGE_BASE".."$local_sha")
    fi
  else
    PUSH_DIFF+=$'\n'$(git diff "$remote_sha".."$local_sha")
    CHANGED_FILES+=$'\n'$(git diff --name-only "$remote_sha".."$local_sha")
  fi
done

if [[ -z "$PUSH_DIFF" ]]; then
  echo "pre-push: no diff to review"
  exit 0
fi

# --- Security scan: block secrets before they leave the machine ---

SCRIPT_DIR="$(cd "$(dirname "$0")/../scripts" && pwd)"
# shellcheck source=../scripts/secrets-scan.sh
source "$SCRIPT_DIR/secrets-scan.sh"
scan_secrets "pre-push" || exit 1

# --- Parallel BATS tests + review agents ---

TMPDIR_REVIEW=$(mktemp -d)
trap 'rm -rf "$TMPDIR_REVIEW"' EXIT
printf '%s\n' "$PUSH_DIFF" >"$TMPDIR_REVIEW/diff.txt"
printf '%s\n' "$CHANGED_FILES" >"$TMPDIR_REVIEW/files.txt"

FINAL_RC=0

if command -v bats &>/dev/null; then
  NCPUS=$(sysctl -n hw.ncpu 2>/dev/null || nproc 2>/dev/null || echo 4)
  HALF=$(( NCPUS / 2 ))
  [[ "$HALF" -lt 1 ]] && HALF=1

  ULOG=$(mktemp)
  ILOG=$(mktemp)

  echo "pre-push: launching tests on ${NCPUS} cores (${HALF} per suite)..."

  # Launch unit + integration tests in parallel
  bats --jobs "$HALF" test/unit/ > "$ULOG" 2>&1 &
  UPID=$!
  bats --jobs "$HALF" test/integration/ > "$ILOG" 2>&1 &
  IPID=$!

  # Launch review agents in parallel
  RLOG=$(mktemp)
  "$SCRIPT_DIR/review.sh" --hook pre-push \
    --diff-file "$TMPDIR_REVIEW/diff.txt" \
    --files-file "$TMPDIR_REVIEW/files.txt" > "$RLOG" 2>&1 &
  RPID=$!

  # Wait for tests first (they're faster)
  URC=0; IRC=0
  wait "$UPID" || URC=$?
  wait "$IPID" || IRC=$?

  if [[ "$URC" -ne 0 ]]; then
    echo "pre-push: Unit tests FAILED:"
    cat "$ULOG"
    FINAL_RC=1
  else
    echo "pre-push: unit tests passed"
  fi

  if [[ "$IRC" -ne 0 ]]; then
    echo "pre-push: Integration tests FAILED:"
    cat "$ILOG"
    FINAL_RC=1
  else
    echo "pre-push: integration tests passed"
  fi

  rm -f "$ULOG" "$ILOG"

  # If tests failed, kill review agents and bail
  if [[ "$FINAL_RC" -ne 0 ]]; then
    echo "pre-push: BLOCKED — tests failed. Killing review agents."
    kill "$RPID" 2>/dev/null || true
    wait "$RPID" 2>/dev/null || true
    rm -f "$RLOG"
    exit 1
  fi

  # Wait for review agents
  RRC=0
  wait "$RPID" || RRC=$?
  cat "$RLOG"
  rm -f "$RLOG"

  if [[ "$RRC" -ne 0 ]]; then
    echo "pre-push: BLOCKED — review agents found issues."
    exit 1
  fi
else
  echo "pre-push: bats not installed, skipping test suite (install: brew install bats-core)"

  # Run review agents only
  "$SCRIPT_DIR/review.sh" --hook pre-push \
    --diff-file "$TMPDIR_REVIEW/diff.txt" \
    --files-file "$TMPDIR_REVIEW/files.txt"
  FINAL_RC=$?
fi

exit $FINAL_RC
