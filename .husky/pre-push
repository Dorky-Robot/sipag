#!/usr/bin/env bash
# .husky/pre-push — full validation before push (~2-3 min)
#
# Hook chain:
#   1. Test suite    (cargo test --workspace — BLOCKING)
#   2. Unused deps   (cargo machete — warning only)
#   3. Secrets scan  (gitleaks — BLOCKING)
#
# Install once per clone:
#   make install-hooks

set -euo pipefail

REPO_ROOT="$(git rev-parse --show-toplevel)"
cd "$REPO_ROOT"

warn() { echo "  WARN  $*" >&2; }
fail() { echo "  ERROR $*" >&2; exit 1; }
step() { echo ""; echo "==> $*"; }

echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "  pre-push checks"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

# ── 1. Test suite (BLOCKING) ──────────────────────────────────────────────────
step "[1/3] Test suite (cargo test --workspace)"
if ! cargo test --workspace; then
    fail "Tests failed — push blocked. Fix failing tests before pushing."
fi
echo "      ✓ All tests passed"

# ── 2. Unused deps (warning only) ────────────────────────────────────────────
step "[2/3] Unused dependencies (cargo machete)"
if command -v cargo-machete >/dev/null 2>&1 || cargo machete --version >/dev/null 2>&1; then
    if ! cargo machete 2>&1; then
        warn "Unused dependency warnings detected (not blocking)."
        warn "Run: cargo machete --fix   to remove them."
    fi
else
    echo "      (skipped — cargo-machete not installed; install with: cargo install cargo-machete)"
fi

# ── 3. Secrets scan (BLOCKING) ───────────────────────────────────────────────
step "[3/3] Secrets scan (gitleaks)"
if command -v gitleaks >/dev/null 2>&1; then
    if ! gitleaks git --no-banner --verbose; then
        fail "Secrets detected — push blocked. Remove secrets before pushing."
    fi
    echo "      ✓ No secrets detected"
else
    warn "gitleaks not installed — skipping secrets scan."
    warn "Install: https://github.com/gitleaks/gitleaks#installing"
fi

echo ""
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "  All pre-push checks passed — proceeding with push."
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
