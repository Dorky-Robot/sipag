#!/usr/bin/env bash
# .husky/pre-commit — fast, deterministic checks (~15 seconds)
#
# Hook chain:
#   1. Secrets scan    (gitleaks — BLOCKING)
#   2. Spell check     (typos — BLOCKING)
#   3. CVE advisories  (cargo deny — BLOCKING)
#   4. Release build   (cargo build --release — BLOCKING)
#   5. Formatting      (cargo fmt --check — BLOCKING)
#   6. Lint            (cargo clippy — BLOCKING)
#   7. Shell lint      (shellcheck — BLOCKING)
#
# Install once per clone:
#   make install-hooks

set -euo pipefail

REPO_ROOT="$(git rev-parse --show-toplevel)"
cd "$REPO_ROOT"

warn() { echo "  WARN  $*" >&2; }
fail() { echo "  ERROR $*" >&2; exit 1; }
step() { echo ""; echo "==> $*"; }

echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "  pre-commit checks"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

# ── 1. Secrets scan (BLOCKING) ────────────────────────────────────────────────
step "[1/7] Secrets scan (gitleaks)"
if command -v gitleaks >/dev/null 2>&1; then
    if ! gitleaks git --pre-commit --no-banner --verbose; then
        fail "Secrets detected — commit blocked. Remove secrets before committing."
    fi
    echo "      ✓ No secrets detected"
else
    warn "gitleaks not installed — skipping secrets scan."
    warn "Install: https://github.com/gitleaks/gitleaks#installing"
fi

# ── 2. Spell check (BLOCKING) ────────────────────────────────────────────────
step "[2/7] Spell check (typos)"
if command -v typos >/dev/null 2>&1; then
    if ! typos; then
        fail "Spelling errors found — commit blocked. Fix typos before committing."
    fi
    echo "      ✓ No spelling errors"
else
    warn "typos not installed — skipping spell check."
    warn "Install: cargo install typos-cli"
fi

# ── 3. CVE advisories (BLOCKING) ─────────────────────────────────────────────
step "[3/7] CVE advisories (cargo deny)"
if command -v cargo-deny >/dev/null 2>&1 || cargo deny --version >/dev/null 2>&1; then
    if ! cargo deny check advisories; then
        fail "Known CVEs found in dependencies — commit blocked. Update or audit deps."
    fi
    echo "      ✓ No known CVEs"
else
    warn "cargo-deny not installed — skipping advisories check."
    warn "Install: cargo install cargo-deny"
fi

# ── 4. Release build (BLOCKING) ────────────────────────────────────────────
step "[4/7] Release build (cargo build --release)"
if ! cargo build --release; then
    fail "Release build failed — commit blocked. Fix build errors before committing."
fi
echo "      ✓ Release build OK"

# ── 5. Formatting (BLOCKING) ─────────────────────────────────────────────────
step "[5/7] Formatting (cargo fmt --check)"
if ! cargo fmt --all -- --check; then
    fail "Formatting errors — commit blocked. Run: cargo fmt"
fi
echo "      ✓ Formatting OK"

# ── 6. Lint (BLOCKING) ───────────────────────────────────────────────────────
step "[6/7] Lint (cargo clippy -D warnings)"
if ! cargo clippy --all-targets -- -D warnings; then
    fail "Clippy warnings — commit blocked. Fix warnings before committing."
fi
echo "      ✓ No clippy warnings"

# ── 7. Shell lint (BLOCKING) ─────────────────────────────────────────────────
step "[7/7] Shell lint (shellcheck)"
if command -v shellcheck >/dev/null 2>&1; then
    if ! shellcheck --severity=warning lib/*.sh lib/worker/*.sh; then
        fail "shellcheck errors — commit blocked. Fix shell script issues before committing."
    fi
    echo "      ✓ Shell scripts OK"
else
    warn "shellcheck not installed — skipping shell lint."
    warn "Install: apt-get install shellcheck  OR  brew install shellcheck"
fi

echo ""
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "  All pre-commit checks passed — proceeding with commit."
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
