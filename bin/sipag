#!/usr/bin/env bash
# sipag — autonomous dev agent powered by Claude Code

set -euo pipefail

SIPAG_VERSION="2.0.0"

# Resolve project root
SIPAG_ROOT="$(cd "$(dirname "$0")/.." && pwd)"

# Source libraries
# shellcheck source=../lib/worker.sh
source "${SIPAG_ROOT}/lib/worker.sh"
# shellcheck source=../lib/setup.sh
source "${SIPAG_ROOT}/lib/setup.sh"
# shellcheck source=../lib/start.sh
source "${SIPAG_ROOT}/lib/start.sh"
# shellcheck source=../lib/merge.sh
source "${SIPAG_ROOT}/lib/merge.sh"
# shellcheck source=../lib/preflight.sh
source "${SIPAG_ROOT}/lib/preflight.sh"

# --- Defaults ---

export WORKER_ONCE=0

# --- Help ---

usage() {
	cat <<'EOF'
sipag — autonomous dev agent powered by Claude Code

Usage:
  sipag start <owner/repo>           Prime session for agile workflow
  sipag work <owner/repo> [--once]   Pick up approved issues, code in Docker
  sipag drain                        Signal workers to finish current batch and exit
  sipag resume                       Clear drain signal so workers continue polling
  sipag merge <owner/repo>           Conversational PR merge session
  sipag setup                        Configure sipag and Claude Code permissions
  sipag version                      Print version
  sipag help                         Show this help

Agile workflow:
  start → (converse, triage, refine, approve) → work → merge

Flags:
      --once         (work) Process one polling cycle and exit (useful for testing)

Config (~/.sipag/config):
  batch_size=4                 Max parallel Docker containers
  image=ghcr.io/dorky-robot/sipag-worker:latest    Docker image for workers
  timeout=1800                 Per-task timeout in seconds
  poll_interval=120            Seconds between polling for new issues

Environment:
  SIPAG_TIMEOUT           Claude timeout in seconds (default: 600)
  SIPAG_MODEL             Model override
  SIPAG_PROMPT_PREFIX     Prepended to every prompt
  SIPAG_SKIP_PERMISSIONS  Set 0 for interactive mode (default: 1)
  SIPAG_CLAUDE_ARGS       Extra raw args to claude
EOF
}

# --- Commands ---

cmd_start() {
	local repo="${1:?Usage: sipag start <owner/repo>}"
	preflight_gh_auth || return 1
	preflight_repo "$repo" || return 1
	start_run "$repo"
}

cmd_setup() {
	setup_run
}

cmd_work() {
	local repo="${1:?Usage: sipag work <owner/repo>}"
	worker_load_config
	preflight_auth || return 1
	preflight_docker_running || return 1
	preflight_docker_image "${WORKER_IMAGE}" || return 1
	preflight_gh_auth || return 1
	if [[ -f "${SIPAG_DIR}/drain" ]]; then
		echo "Warning: stale drain signal found. Clearing it and starting normally."
		echo "Use 'sipag drain' to signal a graceful shutdown."
		rm -f "${SIPAG_DIR}/drain"
	fi
	worker_init
	worker_loop "$repo"
}

cmd_drain() {
	mkdir -p "$SIPAG_DIR"
	touch "${SIPAG_DIR}/drain"
	echo "Drain signal sent. Running workers will finish their current batch and exit."
	echo "Use 'sipag resume' to cancel."
}

cmd_resume() {
	rm -f "${SIPAG_DIR}/drain"
	echo "Drain signal cleared. Workers will continue polling."
}

cmd_merge() {
	local repo="${1:?Usage: sipag merge <owner/repo>}"
	merge_run "$repo"
}

cmd_version() {
	echo "sipag ${SIPAG_VERSION}"
}

# --- Argument parsing ---

main() {
	local command=""

	local work_repo=""
	local start_repo=""
	local merge_repo=""

	while [[ $# -gt 0 ]]; do
		case "$1" in
		start)
			command="start"
			shift
			if [[ $# -gt 0 && "$1" != -* ]]; then
				start_repo="$1"
				shift
			fi
			;;
		setup)
			command="setup"
			shift
			;;
		work)
			command="work"
			shift
			if [[ $# -gt 0 && "$1" != -* ]]; then
				work_repo="$1"
				shift
			fi
			;;
		drain)
			command="drain"
			shift
			;;
		resume)
			command="resume"
			shift
			;;
		merge)
			command="merge"
			shift
			if [[ $# -gt 0 && "$1" != -* ]]; then
				merge_repo="$1"
				shift
			fi
			;;
		version | --version)
			cmd_version
			return 0
			;;
		help | --help | -h)
			usage
			return 0
			;;
		--once)
			export WORKER_ONCE=1
			shift
			;;
		-*)
			echo "Unknown flag: $1"
			usage
			return 1
			;;
		*)
			# If no command yet, treat as command
			if [[ -z "$command" ]]; then
				echo "Unknown command: $1"
				usage
				return 1
			fi
			shift
			;;
		esac
	done

	# Default: show help
	if [[ -z "$command" ]]; then
		usage
		return 0
	fi

	case "$command" in
	start) cmd_start "$start_repo" ;;
	setup) cmd_setup ;;
	work) cmd_work "$work_repo" ;;
	drain) cmd_drain ;;
	resume) cmd_resume ;;
	merge) cmd_merge "$merge_repo" ;;
	esac
}

main "$@"
