name: CI

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install shellcheck
        run: sudo apt-get install -y shellcheck

      - name: Install shfmt
        run: |
          curl -sSL \
            https://github.com/mvdan/sh/releases/download/v3.8.0/shfmt_v3.8.0_linux_amd64 \
            -o /usr/local/bin/shfmt
          chmod +x /usr/local/bin/shfmt

      - name: Run checks (lint + fmt)
        run: make check

  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install bats-core
        run: |
          git clone --depth 1 https://github.com/bats-core/bats-core.git /tmp/bats-core
          sudo /tmp/bats-core/install.sh /usr/local

      - name: Run tests
        run: make test

  security:
    name: Security
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install gitleaks
        run: |
          GITLEAKS_VERSION=8.18.2
          curl -sSL \
            "https://github.com/gitleaks/gitleaks/releases/download/v${GITLEAKS_VERSION}/gitleaks_${GITLEAKS_VERSION}_linux_x64.tar.gz" \
            | tar -xz -C /usr/local/bin gitleaks

      - name: Scan for secrets (PR diff)
        if: github.event_name == 'pull_request'
        run: |
          git fetch origin "$GITHUB_BASE_REF"
          gitleaks detect --source . \
            --log-opts "origin/${GITHUB_BASE_REF}..HEAD" \
            --verbose

      - name: Scan for secrets (push)
        if: github.event_name == 'push'
        run: |
          gitleaks detect --source . --verbose

  ai-review:
    name: AI Review
    runs-on: ubuntu-latest
    # Only runs on PRs; advisory only — never blocks merge
    if: github.event_name == 'pull_request'
    continue-on-error: true
    permissions:
      pull-requests: write
    env:
      ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      GH_TOKEN: ${{ github.token }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for API key
        id: check-key
        run: |
          if [ -z "$ANTHROPIC_API_KEY" ]; then
            echo "skip=true" >> "$GITHUB_OUTPUT"
            echo "No ANTHROPIC_API_KEY configured — skipping AI review"
          else
            echo "skip=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Get PR diff
        if: steps.check-key.outputs.skip == 'false'
        id: diff
        run: |
          git fetch origin "$GITHUB_BASE_REF"
          DIFF=$(git diff "origin/${GITHUB_BASE_REF}..HEAD" -- . \
            ':(exclude)*.lock' ':(exclude)*.sum' \
            | head -c 30000)
          # Write to file to avoid environment variable size limits
          echo "$DIFF" > /tmp/pr.diff
          echo "pr_number=${{ github.event.pull_request.number }}" >> "$GITHUB_OUTPUT"

      - name: Request AI review
        if: steps.check-key.outputs.skip == 'false'
        run: |
          PR_DIFF=$(cat /tmp/pr.diff)
          PR_TITLE="${{ github.event.pull_request.title }}"
          PR_BODY="${{ github.event.pull_request.body }}"

          # Build JSON payload for Claude Haiku
          PAYLOAD=$(jq -n \
            --arg diff "$PR_DIFF" \
            --arg title "$PR_TITLE" \
            --arg body "$PR_BODY" \
            '{
              model: "claude-haiku-4-5",
              max_tokens: 1024,
              messages: [{
                role: "user",
                content: ("You are a code reviewer. Review this pull request and provide concise, actionable feedback.\n\nPR Title: " + $title + "\n\nPR Description:\n" + $body + "\n\nDiff:\n```diff\n" + $diff + "\n```\n\nFocus on:\n- Correctness and bugs\n- Security issues\n- Shell scripting best practices\n- Missing error handling\n\nBe brief. If the code looks good, say so. Format as markdown.")
              }]
            }')

          RESPONSE=$(curl -sSf https://api.anthropic.com/v1/messages \
            -H "x-api-key: $ANTHROPIC_API_KEY" \
            -H "anthropic-version: 2023-06-01" \
            -H "content-type: application/json" \
            -d "$PAYLOAD")

          REVIEW=$(echo "$RESPONSE" | jq -r '.content[0].text // "AI review unavailable."')

          # Post review comment on the PR (advisory, no approval/rejection)
          COMMENT="## AI Code Review (Advisory)\n\n${REVIEW}\n\n---\n*Generated by Claude Haiku — advisory only, does not block merge.*"

          gh pr comment "${{ github.event.pull_request.number }}" \
            --body "$(printf '%b' "$COMMENT")"
