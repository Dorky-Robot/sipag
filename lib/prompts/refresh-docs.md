You are working on the repository at /work (cloned from {{REPO}}).

Your task: Refresh the architecture documentation for this repository.

## What to do

### 1. Analyze the codebase

Study the actual code — not comments, not READMEs, the code itself:

- Run `find . -not -path './.git/*' -type f | sort | head -100` to see the file layout
- Read key source files to understand what each module does
- Run `git log --oneline -20` to see recent changes
- Run `gh pr list --repo {{REPO}} --state merged --limit 10 --json number,title,mergedAt -q '.[] | "#\(.number): \(.title) (\(.mergedAt))"'` to see recent merges

### 2. Generate or update ARCHITECTURE.md

Create or **fully overwrite** ARCHITECTURE.md with a factual, current description. Include:

- **Overview** — 2–3 sentences: what the system does and how it works at a high level
- **Directory Structure** — what each top-level directory contains and why
- **Key Components** — major modules/files, their responsibilities, and how they interact
- **Data Flow** — trace a primary use case from entry point to output
- **Key Types / Data Structures** — important structs, enums, or data models with their fields
- **Runtime File Layout** — what files exist on disk at runtime and what they contain
- **External Dependencies** — tools/libraries used and why

Rules:
- Every claim must be grounded in actual code you read. No aspirational or future-tense statements.
- Be specific: "parses YAML frontmatter from task files in ~/.sipag/queue/" beats "handles task storage"
- If you cannot read a file or understand a module, say so explicitly rather than guessing

### 3. Handle VISION.md

**VISION.md does not exist** → Draft one from README.md, recent issues, and PR history:
- Summarize purpose, target users, and key non-goals in under 100 lines
- Add `<!-- auto-drafted by sipag refresh-docs $(date +%Y-%m-%d) -->` at the very top
- Keep it factual and grounded in what the project actually does today

**VISION.md already exists** → **Do NOT overwrite it**. Instead:
- Read it carefully
- Compare each claim against the actual codebase
- Add or update a `## Staleness Notes` section at the end:
  - List anything that appears stale, incorrect, or contradicted by the code
  - Format: `- [$(date +%Y-%m-%d)] <observation>`
  - If everything looks accurate: `- [$(date +%Y-%m-%d)] Reviewed — no staleness detected`

### 4. Commit and open a PR — only if something changed

After generating the docs:

```bash
git diff --quiet ARCHITECTURE.md VISION.md 2>/dev/null && \
  git ls-files --others --exclude-standard ARCHITECTURE.md VISION.md | grep -q . || {
    echo "No doc changes — nothing to commit."
    exit 0
  }
```

If files changed:

```bash
git add ARCHITECTURE.md VISION.md
git commit -m "docs: refresh ARCHITECTURE.md and VISION.md [$(date +%Y-%m-%d)]"
git push -u origin "$BRANCH"

# Check if a PR already exists for this branch
existing_pr=$(gh pr list --repo {{REPO}} --head "$BRANCH" --state open --json number -q '.[0].number' 2>/dev/null || true)
if [[ -z "$existing_pr" ]]; then
  gh pr create \
    --repo {{REPO}} \
    --title "docs: refresh architecture documentation ($(date +%Y-%m-%d))" \
    --body "Auto-generated by \`sipag refresh-docs\`.

Updates ARCHITECTURE.md to reflect the current codebase state. $(if [[ -f VISION.md ]]; then echo "VISION.md staleness notes updated."; else echo "VISION.md drafted from README and issue history."; fi)

---
*This PR was opened automatically. Review ARCHITECTURE.md for accuracy before merging.*" \
    --head "$BRANCH"
fi
```

If nothing changed, output "No doc changes detected." and exit 0 without committing.
